/**
 * ATOMIC GAMES - CLIENT SIDE APPLICATION
 * Architecture: Hybrid Sync (Instant API + Static Fallback)
 * VERSION: 3.0 (Premium)
 */

const AtomicApp = (() => {
    const CONFIG = {
        SERVER_URL: window.location.origin,
        WHATSAPP: '5521995969378'
    };

    const State = {
        products: [],
        cart: JSON.parse(localStorage.getItem('atomic_cart') || '[]'),
        filter: 'all'
    };

    const UI = {
        grid: document.getElementById('productGrid'),
        cartCount: document.getElementById('cartCount'),
        searchInput: document.getElementById('searchInput'),
        themeToggle: document.getElementById('themeToggle'),
        videoFacade: document.getElementById('videoFacade'),
        videoContainer: document.getElementById('videoContainer')
    };

    const Utils = {
        formatPrice: (p) => {
            if (typeof p === 'number') return p.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            let clean = String(p).replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
            let val = parseFloat(clean) || 0;
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
    };

    const Animation = {
        init: () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }
    };

    const Catalog = {
        fetch: async () => {
            console.log("ðŸ“¦ Sincronizando Arsenal Atomic...");
            try {
                // Tenta buscar da API pÃºblica do servidor (atualizaÃ§Ã£o em tempo real do Admin)
                const res = await fetch(`${CONFIG.SERVER_URL}/api/public/products`);
                if (!res.ok) throw new Error("Server API offline");
                State.products = await res.json();
            } catch (e) {
                console.warn("âš ï¸ API offline, usando fallback do GitHub.");
                const fb = await fetch(`https://raw.githubusercontent.com/atomicgamesbrasil/siteoficial/main/produtos.json?t=${Date.now()}`);
                State.products = await fb.json();
            } finally {
                Catalog.render();
            }
        },

        render: () => {
            if (!UI.grid) return;
            const term = (UI.searchInput ? UI.searchInput.value.toLowerCase() : "");
            
            const filtered = State.products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(term);
                const matchesFilter = State.filter === 'all' || (p.category && p.category.toLowerCase() === State.filter);
                return matchesSearch && matchesFilter;
            });

            UI.grid.innerHTML = '';
            if (filtered.length === 0) {
                UI.grid.innerHTML = '<div class="col-span-full py-20 text-center text-muted font-bold opacity-50">Nenhum item encontrado no arsenal.</div>';
                return;
            }

            filtered.forEach(p => {
                const card = document.createElement('article');
                card.className = 'product-card bg-white dark:bg-slate-800 rounded-3xl border border-slate-100 dark:border-slate-700 p-5 flex flex-col h-full reveal active shadow-sm group';
                card.innerHTML = `
                    <div class="relative h-44 mb-6 bg-slate-50 dark:bg-slate-900 rounded-2xl p-4 flex items-center justify-center overflow-hidden cursor-pointer" onclick="AtomicApp.Interface.showDetail('${p.id}')">
                        <img src="${p.image}" class="max-h-full max-w-full object-contain group-hover:scale-110 transition-transform duration-500">
                        <span class="absolute top-2 left-2 px-2 py-1 bg-black/50 backdrop-blur-md rounded-lg text-[10px] text-yellow-500 font-black uppercase tracking-widest">${p.category}</span>
                    </div>
                    <h3 class="font-bold text-sm mb-2 line-clamp-2 h-10">${p.name}</h3>
                    <div class="mt-auto flex justify-between items-center pt-4">
                        <span class="font-black text-xl text-gradient">${Utils.formatPrice(p.price)}</span>
                        <button class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center text-black hover:bg-yellow-400 active:scale-90 transition" onclick="AtomicApp.Cart.add('${p.id}')">
                            <i class="ph-bold ph-plus"></i>
                        </button>
                    </div>
                `;
                UI.grid.appendChild(card);
            });
        }
    };

    const Cart = {
        save: () => localStorage.setItem('atomic_cart', JSON.stringify(State.cart)),
        add: (id) => {
            const p = State.products.find(x => x.id === id);
            if (p) {
                State.cart.push(p);
                Cart.save();
                Cart.updateUI();
                // Efeito sonoro ou haptic feedback poderia entrar aqui
            }
        },
        updateUI: () => {
            if (UI.cartCount) {
                const count = State.cart.length;
                UI.cartCount.textContent = count;
                UI.cartCount.classList.toggle('hidden', count === 0);
                if (count > 0) UI.cartCount.classList.add('animate-bounce');
                setTimeout(() => UI.cartCount.classList.remove('animate-bounce'), 500);
            }
        }
    };

    const Interface = {
        init: () => {
            // Theme
            if (localStorage.getItem('atomic-theme') === 'dark') document.documentElement.classList.add('dark');
            UI.themeToggle?.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('atomic-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });

            // Video
            UI.videoFacade?.addEventListener('click', function() {
                const vidId = this.dataset.videoId;
                UI.videoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${vidId}?autoplay=1" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="rounded-[2rem]"></iframe>`;
                this.classList.add('hidden');
                UI.videoContainer.classList.remove('hidden');
            });

            // Filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active', 'bg-yellow-500', 'text-black'));
                    e.currentTarget.classList.add('active', 'bg-yellow-500', 'text-black');
                    State.filter = e.currentTarget.dataset.category;
                    Catalog.render();
                });
            });

            // Search
            UI.searchInput?.addEventListener('input', () => Catalog.render());

            // Modal Detail Closers
            document.getElementById('closeDetailBtn')?.addEventListener('click', Interface.hideDetail);
            document.getElementById('productDetailOverlay')?.addEventListener('click', Interface.hideDetail);

            // Chat Widget
            document.getElementById('chatBubble')?.addEventListener('click', () => {
                document.getElementById('chatWindow').style.display = 'flex';
            });
            document.getElementById('closeChatBtn')?.addEventListener('click', () => {
                document.getElementById('chatWindow').style.display = 'none';
            });

            // Chart ReputaÃ§Ã£o
            const ctx = document.getElementById('reputationChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['PreÃ§o', 'Velocidade', 'Qualidade', 'Atendimento', 'Garantia'],
                        datasets: [{
                            data: [4.8, 4.5, 5, 4.9, 5],
                            backgroundColor: 'rgba(255, 215, 0, 0.2)',
                            borderColor: '#FFD700',
                            borderWidth: 2,
                            pointBackgroundColor: '#FFD700'
                        }]
                    },
                    options: {
                        scales: { r: { min: 0, max: 5, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        },

        showDetail: (id) => {
            const p = State.products.find(x => x.id === id);
            if (!p) return;
            
            document.getElementById('modalProductImage').src = p.image;
            document.getElementById('modalProductName').textContent = p.name;
            document.getElementById('modalProductDescription').textContent = p.desc || 'Este item do arsenal Atomic nÃ£o possui descriÃ§Ã£o detalhada no momento, mas garantimos a qualidade mÃ¡xima.';
            document.getElementById('modalProductPrice').textContent = Utils.formatPrice(p.price);
            document.getElementById('modalWhatsappBtn').href = `https://wa.me/${CONFIG.WHATSAPP}?text=OlÃ¡! Vi o ${p.name} no site e tenho interesse.`;
            
            document.getElementById('productDetailOverlay').classList.add('open');
            document.getElementById('productDetailModal').classList.add('open');
        },

        hideDetail: () => {
            document.getElementById('productDetailOverlay').classList.remove('open');
            document.getElementById('productDetailModal').classList.remove('open');
        }
    };

    return {
        init: () => {
            Catalog.fetch();
            Interface.init();
            Animation.init();
            Cart.updateUI();
            
            // Limpa Service Workers antigos para evitar problemas de cache agressivo
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
            }
        },
        Interface: { showDetail: Interface.showDetail },
        Cart: { add: Cart.add }
    };
})();

document.addEventListener('DOMContentLoaded', AtomicApp.init);
