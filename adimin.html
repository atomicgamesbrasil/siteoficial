<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atomic Games - Backoffice</title>
    
    <!-- METADATA PARA REDES SOCIAIS (WhatsApp, etc) -->
    <meta property="og:title" content="Atomic Games - Painel Administrativo">
    <meta property="og:description" content="Acesso restrito para gestão de loja e produtos.">
    <meta property="og:image" content="https://raw.githubusercontent.com/atomicgamesbrasil/siteoficial/main/img%20site/img2.jpeg">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:type" content="website">

    <!-- FAVICON -->
    <link rel="icon" type="image/webp" href="https://raw.githubusercontent.com/atomicgamesbrasil/siteoficial/main/img%20site/atomiclogo.webp">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Fontes */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Rajdhani:wght@500;700&display=swap');

        /* ---------------------------------------------------- */
        /* CONFIGURAÇÃO DE TEMAS E HARMONIA VISUAL             */
        /* ---------------------------------------------------- */

        body {
            font-family: 'Inter', sans-serif;
            transition: background-image 0.5s ease, background-color 0.5s ease;
            color: #f1f5f9;
        }

        /* --- MODO PADRÃO (DARK / SÓLIDO) --- */
        /* Foco total no trabalho, sem distrações de fundo */
        body[data-theme="dark"] {
            background-color: #0f172a; /* Slate 900 */
            background-image: none;
        }
        
        body[data-theme="dark"] .glass-panel,
        body[data-theme="dark"] aside,
        body[data-theme="dark"] nav,
        body[data-theme="dark"] .content-area {
            background-color: #0f172a; /* Sólido */
            border-color: #1e293b;
        }

        /* --- MODO VISUALIZAÇÃO (IMAGEM + HARMONIA) --- */
        /* Imagem de fundo presente, mas o conteúdo flutua em blocos quase sólidos para legibilidade */
        body[data-theme="light"] {
            /* Imagem 1 no fundo */
            background-image: url('https://raw.githubusercontent.com/atomicgamesbrasil/siteoficial/main/img%20site/img1.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Ajuste de Harmonia: Painéis escuros e quase opacos sobre a imagem */
        body[data-theme="light"] .glass-panel,
        body[data-theme="light"] aside,
        body[data-theme="light"] nav,
        body[data-theme="light"] .content-area {
            background: rgba(11, 17, 32, 0.92); /* Muito escuro e quase sólido (92%) */
            backdrop-filter: blur(8px);         /* Leve desfoque no que está atrás */
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08); /* Borda sutil para separar da imagem */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        /* Navbar no modo imagem fica um pouco mais translúcida para estilo */
        body[data-theme="light"] nav {
            background: rgba(11, 17, 32, 0.95);
        }

        /* --- TELA DE LOGIN (MÁSCARA COM IMAGEM 2) --- */
        #authOverlay {
            /* Imagem 2 no fundo do login */
            background-image: url('https://raw.githubusercontent.com/atomicgamesbrasil/siteoficial/main/img%20site/img2.jpeg');
            background-size: cover;
            background-position: center;
            position: absolute;
            inset: 0;
            z-index: 100;
        }
        
        #authOverlay::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.65); /* Máscara escura para ler o login */
            backdrop-filter: blur(4px);
            z-index: 101;
        }
        
        #authBox {
            position: relative;
            z-index: 102;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* --- SWITCH (INTERRUPTOR) CUSTOMIZADO --- */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #eab308; /* Yellow-500 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #eab308; /* Yellow-500 */
        }
        
        /* ---------------------------------------------------- */
        
        h1, h2, h3 { font-family: 'Rajdhani', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 10s linear infinite; }
        
        .modal-enter-active { transition: opacity 0.3s; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" data-theme="dark">

    <!-- NAVBAR -->
    <nav class="border-b border-slate-700 h-16 flex items-center justify-between px-6 shadow-lg z-20 transition-colors">
        <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/atomicgamesbrasil/siteoficial/main/img%20site/atomiclogo.webp" 
                 onerror="this.src='https://placehold.co/100?text=A'"
                 alt="Logo Atomic"
                 class="h-9 w-9 rounded-full animate-spin-slow bg-black ring-2 ring-yellow-400/50">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                ATOMIC ADMIN
            </h1>
        </div>
        
        <div class="flex items-center gap-6">
            <!-- INTERRUPTOR DE TEMA -->
            <div class="flex items-center gap-3 cursor-pointer group" onclick="toggleTheme()">
                <span class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-yellow-400 transition-colors">
                    Mudar modo de visualização
                </span>
                <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="themeToggleCheckbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 border-slate-700 appearance-none cursor-pointer transition-all duration-300 left-0" style="top: -2px;"/>
                    <label for="toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer transition-colors duration-300"></label>
                </div>
            </div>

            <div class="h-6 w-px bg-slate-700 mx-2"></div>

            <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/50 text-xs border border-slate-700">
                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse" id="statusDot"></div>
                <span class="text-slate-400 font-semibold" id="statusText">Off</span>
            </div>
            
            <button id="btnLogout" onclick="logout()" class="hidden text-slate-400 hover:text-red-500 transition-colors" title="Sair">
                <i class="fa-solid fa-power-off text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- LAYOUT PRINCIPAL -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside class="w-64 border-r border-slate-800 flex flex-col hidden md:flex transition-all z-10">
            <div class="p-4">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Navegação</p>
                <nav class="space-y-1">
                    <button onclick="showSection('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-4 py-3 rounded-lg bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 flex items-center gap-3 font-medium">
                        <i class="fa-solid fa-chart-line w-5"></i> Dashboard
                    </button>
                    <button onclick="showSection('products')" id="nav-products" class="nav-item w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800/50 hover:text-white transition-all flex items-center gap-3 font-medium">
                        <i class="fa-solid fa-box-open w-5"></i> Produtos
                    </button>
                </nav>
            </div>
            
            <div class="mt-auto p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 p-2 rounded-lg bg-slate-800/30 border border-slate-700/50">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-yellow-500 to-orange-600 flex items-center justify-center text-xs font-bold shadow-lg text-black">A</div>
                    <div>
                        <p class="text-sm font-bold text-white leading-tight">Master Admin</p>
                        <p class="text-[10px] text-emerald-500 font-mono">● Conectado</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ÁREA DE CONTEÚDO -->
        <div class="content-area flex-1 p-6 overflow-auto custom-scroll relative z-0">
            
            <!-- TELA DE LOGIN (OVERLAY) -->
            <div id="authOverlay" class="flex items-center justify-center">
                <div id="authBox" class="w-full max-w-md p-8 rounded-2xl shadow-2xl relative">
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-full h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent"></div>
                    
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-5 border-2 border-yellow-500/30 shadow-2xl">
                            <i class="fa-solid fa-shield-halved text-3xl text-yellow-500"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white">Acesso Restrito</h2>
                        <p class="text-slate-400 text-sm mt-1">Painel Administrativo Atomic Games</p>
                    </div>

                    <form onsubmit="handleLogin(event)" class="space-y-5">
                        <div class="relative group">
                            <i class="fa-solid fa-key absolute left-3 top-3.5 text-slate-500 group-focus-within:text-yellow-500 transition-colors"></i>
                            <input type="password" id="loginPassword" placeholder="Senha do Sistema" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg py-3 pl-10 pr-10 text-white focus:outline-none focus:border-yellow-500 transition-colors placeholder-slate-600">
                            <button type="button" onclick="togglePass()" class="absolute right-3 top-3.5 text-slate-500 hover:text-white transition-colors">
                                <i id="toggleIcon" class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit" class="w-full py-3.5 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 text-black font-bold rounded-lg shadow-lg transition-all transform active:scale-[0.98] uppercase tracking-wide text-sm">
                            <i class="fa-solid fa-right-to-bracket mr-2"></i> Entrar no Sistema
                        </button>
                    </form>
                    <p id="loginMsg" class="text-center text-xs text-red-400 mt-4 h-4 font-bold hidden bg-red-500/10 py-1 rounded border border-red-500/20"></p>
                </div>
            </div>

            <!-- DASHBOARD -->
            <div id="section-dashboard" class="space-y-6 fade-in">
                <header class="mb-8">
                    <h2 class="text-4xl font-bold text-white mb-2">Dashboard</h2>
                    <p class="text-slate-400">Visão geral do sistema e métricas.</p>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-2xl border-l-4 border-yellow-500 relative overflow-hidden group">
                        <div class="absolute right-[-10px] top-[-10px] opacity-[0.05] group-hover:opacity-[0.1] transition-opacity transform group-hover:scale-110 duration-500">
                            <i class="fa-solid fa-gamepad text-9xl text-white"></i>
                        </div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Total de Produtos</p>
                        <h3 id="statTotalProducts" class="text-5xl font-bold text-white mt-2 drop-shadow-lg">-</h3>
                    </div>
                    
                    <div class="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500 relative overflow-hidden">
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Status da API</p>
                        <div class="flex items-center gap-3 mt-3">
                            <span class="relative flex h-3 w-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                            </span>
                            <h3 class="text-2xl font-bold text-white">Operacional</h3>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-2 font-mono">GitHub API v3: Connected</p>
                    </div>
                </div>
            </div>

            <!-- PRODUTOS -->
            <div id="section-products" class="hidden space-y-6 fade-in">
                <header class="flex flex-col md:flex-row justify-between md:items-end gap-4 pb-4 border-b border-slate-700/50">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Catálogo</h2>
                        <p class="text-slate-400">Gerenciamento de estoque e itens do site.</p>
                    </div>
                    <button onclick="openProductModal()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-black px-6 py-3 rounded-lg font-bold shadow-lg transition-all transform hover:-translate-y-1 flex items-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i> Novo Produto
                    </button>
                </header>

                <div class="glass-panel rounded-xl overflow-hidden border border-slate-700/50 shadow-xl">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/80 text-slate-400 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="p-5 font-bold">Item</th>
                                <th class="p-5 font-bold">Nome</th>
                                <th class="p-5 font-bold">Categoria</th>
                                <th class="p-5 font-bold">Preço</th>
                                <th class="p-5 font-bold text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="text-sm divide-y divide-slate-700/30">
                            <!-- JS preenche aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- MODAL PRODUTO -->
    <div id="productModal" class="fixed inset-0 z-[60] bg-black/80 hidden items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="glass-panel w-full max-w-lg rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[90vh] transform scale-95 transition-transform" id="productModalContent">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-900/80 rounded-t-2xl">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-pen-to-square text-yellow-500"></i> <span id="modalTitle">Gerenciar Produto</span>
                </h3>
                <button onclick="closeProductModal()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="addProductForm" class="p-6 space-y-4 overflow-y-auto custom-scroll bg-slate-900/40">
                <input type="hidden" id="prodId">
                <div class="grid grid-cols-2 gap-5">
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nome do Produto</label>
                        <input type="text" id="prodTitle" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-yellow-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Preço (R$)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-slate-500">R$</span>
                            <input type="text" id="prodPrice" placeholder="0,00" oninput="formatCurrency(this)" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 pl-9 text-white outline-none focus:border-yellow-500 font-mono">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Categoria</label>
                        <select id="prodGenre" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-yellow-500 cursor-pointer">
                            <option value="games">Jogos</option>
                            <option value="console">Consoles</option>
                            <option value="acessorios">Acessórios</option>
                            <option value="hardware">Hardware</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Imagem</label>
                        <label class="flex items-center gap-3 w-full bg-slate-800 border border-slate-600 border-dashed rounded-lg p-3 cursor-pointer hover:bg-slate-700 hover:border-yellow-500 transition-all group">
                            <div class="w-8 h-8 rounded-full bg-yellow-500/20 flex items-center justify-center group-hover:bg-yellow-500 group-hover:text-black transition-colors">
                                <i class="fa-solid fa-cloud-arrow-up text-yellow-500 group-hover:text-black"></i>
                            </div>
                            <span class="text-sm text-slate-400 group-hover:text-white">Clique para selecionar imagem...</span>
                            <input type="file" id="prodFile" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Descrição Curta</label>
                        <textarea id="prodDesc" rows="3" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-yellow-500 resize-none text-sm"></textarea>
                    </div>
                </div>
                <p id="prodModalStatus" class="text-center text-xs font-bold text-yellow-400 hidden mt-2 animate-pulse"></p>
            </form>

            <div class="p-5 border-t border-slate-700 bg-slate-900/80 flex justify-end gap-3 rounded-b-2xl">
                <button type="button" onclick="closeProductModal()" class="px-5 py-2.5 text-sm font-bold text-slate-400 hover:text-white transition-colors">Cancelar</button>
                <button type="button" onclick="submitProductForm()" id="btnSaveProduct" class="px-8 py-2.5 bg-yellow-500 text-black font-bold rounded-lg shadow-lg hover:bg-orange-500 transition-colors">Salvar Produto</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // CONFIG
        const APP_PASSWORD = "atomic-master";
        const GH_REPO = "atomicgamesbrasil/siteoficial";
        const EMBEDDED_TOKEN_PART = "XnBgEWSOFOv1SGfvtLCktpZqrdJ2SV1XoDT5";
        
        let currentProducts = [];

        // --- LÓGICA DE TEMA (BACKGROUND & SWITCH) ---
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('atomic_theme', theme);
            
            const checkbox = document.getElementById('themeToggleCheckbox');
            
            if (theme === 'light') {
                checkbox.checked = true; // Switch ligado (Modo Imagem)
                // Estilos "Light Mode" já tratados no CSS para manter harmonia
            } else {
                checkbox.checked = false; // Switch desligado (Modo Dark/Padrão)
            }
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            applyTheme(current === 'dark' ? 'light' : 'dark');
        }

        // --- AUTH ---
        function handleLogin(e) {
            e.preventDefault();
            const pass = document.getElementById('loginPassword').value;
            const btn = e.target.querySelector('button[type="submit"]');
            
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verificando...';
            
            setTimeout(() => {
                if (pass === APP_PASSWORD) {
                    sessionStorage.setItem('atomic_auth', 'true');
                    loginSuccess();
                } else {
                    const msg = document.getElementById('loginMsg');
                    msg.innerText = "Senha Incorreta. Tente novamente.";
                    msg.classList.remove('hidden');
                    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket mr-2"></i> Entrar no Sistema';
                }
            }, 800);
        }

        function loginSuccess() {
            // Esconde a tela de login (que tem a img2)
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('btnLogout').classList.remove('hidden');
            
            // Ativa o Modo Imagem (Light) automaticamente ao logar
            applyTheme('light');
            
            document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
            document.getElementById('statusText').innerText = "Online";
            document.getElementById('statusText').className = "text-emerald-400 font-bold text-xs";
            loadData();
        }

        function logout() {
            if(confirm("Deseja desconectar do painel?")) {
                sessionStorage.removeItem('atomic_auth');
                location.reload();
            }
        }

        // --- DADOS ---
        function getRealToken() {
            let localToken = localStorage.getItem('atomic_gh_token');
            if (localToken) return localToken.startsWith('ghp_') ? localToken : 'ghp_' + localToken;
            return 'ghp_' + EMBEDDED_TOKEN_PART;
        }

        async function loadData() {
            try {
                const res = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/produtos.json`, {
                    headers: { 'Authorization': `token ${getRealToken()}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    currentProducts = JSON.parse(content);
                } else {
                    currentProducts = [];
                }
                renderProducts(currentProducts);
                document.getElementById('statTotalProducts').innerText = currentProducts.length;
            } catch (e) {
                console.error(e);
                document.getElementById('productsTableBody').innerHTML = '<tr><td colspan="5" class="p-6 text-center text-red-400 bg-red-500/10 rounded-lg m-4"><i class="fa-solid fa-wifi mr-2"></i> Erro de Conexão com GitHub</td></tr>';
            }
        }

        function renderProducts(list) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-500 italic">Nenhum produto encontrado.</td></tr>';
                return;
            }
            list.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/50 border-b border-slate-700/30 transition-colors group";
                
                let catBadge = "bg-slate-800 text-slate-400";
                if(p.category === 'console') catBadge = "bg-purple-500/20 text-purple-300 border border-purple-500/30";
                if(p.category === 'games') catBadge = "bg-green-500/20 text-green-300 border border-green-500/30";
                if(p.category === 'acessorios') catBadge = "bg-blue-500/20 text-blue-300 border border-blue-500/30";
                if(p.category === 'hardware') catBadge = "bg-red-500/20 text-red-300 border border-red-500/30";

                tr.innerHTML = `
                    <td class="p-4 pl-5">
                        <div class="w-12 h-12 rounded-lg bg-slate-950 border border-slate-700 overflow-hidden flex items-center justify-center shadow-sm">
                            <img src="${p.image || '#'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100/1e293b/475569?text=IMG'">
                        </div>
                    </td>
                    <td class="p-4 font-bold text-white group-hover:text-yellow-400 transition-colors">${p.name}</td>
                    <td class="p-4"><span class="px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${catBadge}">${p.category}</span></td>
                    <td class="p-4 text-emerald-400 font-mono font-bold tracking-tight">${p.price}</td>
                    <td class="p-4 pr-5 text-right">
                        <button onclick="startEdit('${p.id}')" class="text-slate-500 hover:text-yellow-400 p-2 rounded hover:bg-yellow-500/10 transition-all mr-1" title="Editar"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteProduct('${p.id}')" class="text-slate-500 hover:text-red-400 p-2 rounded hover:bg-red-500/10 transition-all" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- SALVAR ---
        async function submitProductForm() {
            const btn = document.getElementById('btnSaveProduct');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Salvando...';
            btn.disabled = true;
            
            const id = document.getElementById('prodId').value;
            const title = document.getElementById('prodTitle').value;
            let price = document.getElementById('prodPrice').value;
            const genre = document.getElementById('prodGenre').value;
            const desc = document.getElementById('prodDesc').value;
            const fileInput = document.getElementById('prodFile');
            const statusMsg = document.getElementById('prodModalStatus');

            if(!title || !price) {
                statusMsg.innerText = "Preencha nome e preço!";
                statusMsg.classList.remove('hidden');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            if(!price.includes('R$')) price = `R$ ${price}`;

            try {
                let imageUrl = "";
                if(id) {
                    const existing = currentProducts.find(p => p.id === id);
                    if(existing) imageUrl = existing.image;
                }

                if(fileInput.files[0]) {
                    statusMsg.innerText = "Enviando imagem para o servidor...";
                    statusMsg.classList.remove('hidden');
                    const file = fileInput.files[0];
                    const cleanName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '-')}`;
                    const path = `img%20site/${cleanName}`;
                    const base64 = await toBase64(file);
                    await uploadToGitHub(path, base64.split(',')[1]);
                    imageUrl = `https://raw.githubusercontent.com/${GH_REPO}/main/${path}`;
                }

                statusMsg.innerText = "Atualizando catálogo...";
                const product = { id: id || Date.now().toString(), name: title, price, category: genre, desc, image: imageUrl };
                await updateJson(product, !!id);
                
                closeProductModal();
                loadData();
            } catch(e) {
                alert("Erro ao salvar: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                statusMsg.classList.add('hidden');
            }
        }

        async function updateJson(item, isEdit, isDelete = false) {
            const url = `https://api.github.com/repos/${GH_REPO}/contents/produtos.json`;
            const token = getRealToken();
            
            // Get Current SHA
            let products = [], sha = null;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` }});
                if(res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                    products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                }
            } catch(e) {}

            if(isDelete) {
                products = products.filter(p => p.id !== item.id);
            } else if (isEdit) {
                const idx = products.findIndex(p => p.id === item.id);
                if(idx !== -1) products[idx] = item;
            } else {
                products.unshift(item);
            }

            const content = btoa(unescape(encodeURIComponent(JSON.stringify(products, null, 2))));
            
            await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Update via Admin",
                    content: content,
                    sha: sha
                })
            });
        }

        async function uploadToGitHub(path, content) {
            const url = `https://api.github.com/repos/${GH_REPO}/contents/${path}`;
            const token = getRealToken();
            await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Img upload", content: content })
            });
        }

        // --- UTIL ---
        function togglePass() {
            const el = document.getElementById('loginPassword');
            const icon = document.getElementById('toggleIcon');
            if (el.type === 'password') {
                el.type = 'text';
                icon.className = 'fa-solid fa-eye-slash';
            } else {
                el.type = 'password';
                icon.className = 'fa-solid fa-eye';
            }
        }
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        function formatCurrency(i) {
            let v = i.value.replace(/\D/g,'');
            v = (v/100).toFixed(2) + '';
            v = v.replace(".", ",");
            i.value = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        }

        function showSection(id) {
            document.getElementById('section-dashboard').classList.add('hidden');
            document.getElementById('section-products').classList.add('hidden');
            document.getElementById('section-'+id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-yellow-500/10', 'text-yellow-400', 'border-yellow-500/20');
                el.classList.add('text-slate-400');
            });
            const btn = document.getElementById('nav-'+id);
            btn.classList.remove('text-slate-400');
            btn.classList.add('bg-yellow-500/10', 'text-yellow-400', 'border-yellow-500/20');
        }

        function openProductModal() {
            const modal = document.getElementById('productModal');
            modal.classList.remove('hidden');
            // Pequeno delay para animação CSS
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('productModalContent').classList.remove('scale-95');
            }, 10);
            
            document.getElementById('addProductForm').reset();
            document.getElementById('prodId').value = "";
            document.getElementById('modalTitle').innerText = "Novo Produto";
            document.getElementById('prodModalStatus').classList.add('hidden');
        }
        function closeProductModal() {
            const modal = document.getElementById('productModal');
            modal.classList.add('opacity-0');
            document.getElementById('productModalContent').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function startEdit(id) {
            const p = currentProducts.find(x => x.id === id);
            document.getElementById('prodId').value = p.id;
            document.getElementById('prodTitle').value = p.name;
            document.getElementById('prodPrice').value = p.price.replace('R$ ', '');
            document.getElementById('prodGenre').value = p.category;
            document.getElementById('prodDesc').value = p.desc;
            document.getElementById('modalTitle').innerText = "Editar Produto";
            openProductModal();
        }
        
        async function deleteProduct(id) {
            if(confirm("Tem certeza que deseja excluir este produto?")) {
                await updateJson({id}, false, true);
                loadData();
            }
        }

        // Init
        if (sessionStorage.getItem('atomic_auth') === 'true') {
            loginSuccess();
        } else {
             // Garante que o checkbox comece certo (desligado/dark) se não estiver logado
             document.getElementById('themeToggleCheckbox').checked = false;
        }
    </script>
</body>
</html>
